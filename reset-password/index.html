<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password</title>
  <link rel="stylesheet" href="/css/resetPassword.css">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="/javascript/authGuard.js"></script>
</head>
<body>
  <div class="container">
    <h2>Reset Your Password</h2>

    <form id="resetForm" style="display: none;">
      <div class="input-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" required>
      </div>

      <div class="input-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" required>
      </div>

      <button type="submit">Update Password</button>
    </form>

    <p id="message"></p>
  </div>

  <script>
    // Supabase client
    const SUPABASE_URL = "https://ltuoxjnbknwutuclsjqy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dW94am5ia253dXR1Y2xzanF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMTQ2NjEsImV4cCI6MjA3MDY5MDY2MX0.hWrDsgTddY2wyFUijYYI8rGvSwtsVt5ZwD4y1I8sZiE";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
    const resetForm = document.getElementById("resetForm");
    const message = document.getElementById("message");
  
    // Check if we're in a recovery session (from Supabase email link)
    async function checkRecoverySession() {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const type = hashParams.get("type");
  
      if (type === "recovery") {
        resetForm.style.display = "block"; // show password form
      } else {
        showMessage("Invalid or expired reset link.", "error");
      }
    }
  
    // Utility to display messages
    function showMessage(text, type = "error") {
      message.textContent = text;
      if (type === "success") {
        message.classList.add("success");
      } else {
        message.classList.remove("success");
      }
    }
  
    // Handle password reset form
    resetForm.addEventListener("submit", async (e) => {
      e.preventDefault();
  
      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
  
      if (newPassword !== confirmPassword) {
        showMessage("Passwords do not match!", "error");
        return;
      }
  
      const { error } = await supabase.auth.updateUser({
        password: newPassword,
      });
  
      if (error) {
        showMessage("Error: " + error.message, "error");
      } else {
        showMessage("âœ… Password updated successfully! You can now log in.", "success");
        resetForm.style.display = "none";
      }
    });
  
    checkRecoverySession();
  </script>
  